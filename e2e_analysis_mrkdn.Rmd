---
title: "e2e_analysis_mrkdn"
author: "ricardo_piedrahita"
date: "12/30/2019"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    source: embed
    vertical_layout: scroll
---

```{r global, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## Analyze UNOPS E2E data
library(lubridate)
library(plyr)
library(dplyr)
library(devtools)
library(shiny)
library(readxl)
library(shinydashboard)
library(DT)
library(data.table)
library(shinyjs)
library(ggplot2)
library(plotly)
library(flexdashboard)
library(rsconnect)
source('r_scripts/load_data_functions_paths.R') #does this import the data??
# preplacement <- as.data.table(readRDS("Processed Data/preplacement.R"))

```

Inputs {.sidebar}
=====================================
```{r}

HTML("<p>Explore UNOPS/E2E data</p>")
selectInput('HHID', HTML("<strong>Select a deployment</strong>"), choices = unique(preplacement[, "HHIDnumeric"][order(HHIDnumeric)]), 
            selected =NULL, multiple = TRUE, selectize = FALSE, width = NULL, size = NULL)

```


```{r}
# Reactive that returns the whole dataset if there is no selection
# Sets data based on inputs, is for the plots
selected_pre <- reactive({
  preplacement <- preplacement[HHIDnumeric %in% input$HHID]
  preplacement$maxdatetime <- CO_calibrated_timeseries[CO_ppm>-1 & HHID %in% input$HHID,lapply(.SD,max),.SDcols="datetime"]
  preplacement$mindatetime <- CO_calibrated_timeseries[CO_ppm>-1 & HHID %in% input$HHID,lapply(.SD,min),.SDcols="datetime"]
  return(preplacement)})

selected_COppm <- reactive({
  COppm <- CO_calibrated_timeseries[CO_ppm>-1 & HHID %in% input$HHID,c("CO_ppm","datetime","sampletype","emission_tags","qc")]
  return(COppm)})

selected_pats <- reactive({
  pats <- pats_data_timeseries[HHID %in% input$HHID,c("PM_Estimate","datetime","sampletype","emission_tags","qc")]
  return(pats)})

selected_ecm <- reactive({
  ecm <- ecmdata[HHID %in% input$HHID,c("pm2.5ugm3","datetime","sampletype","emission_tags","qc")]
  return(ecm)})

selected_beacon <- reactive({
  beacon <- beacon_logger_COmerged[HHID %in% input$HHID,c("location_nearest","location_kitchen_threshold","datetime","nearest_RSSI")]
  return(beacon)})

selected_tsi <- reactive({
  tsi_timeseries <- as.data.table(readRDS("~/Dropbox/UNOPS emissions exposure/E2E Data Analysis/Processed Data/tsi_timeseries.rds"))
  tsi <- tsi_timeseries[HHID %in% input$HHID,c("datetime","loggerID","HHID","qc","emission_tags","CO_ppm","CO2_ppm")]
  return(tsi)})

#Figure border spacing
m <- list(l = 0,r = 0,b = 0,t = 10,pad = 4)

output$COppm = renderPlot({
  p <- ggplot(aes(y = CO_ppm, x = datetime), data = selected_COppm()) + 
    geom_point(aes(shape = emission_tags, colour = sampletype, group = qc), alpha=0.25) + 
    theme_bw(10) +
    theme(legend.title=element_blank()) +
    xlab(" ") +
    coord_cartesian(xlim=c(selected_pre()$mindatetime,selected_pre()$maxdatetime)) + 
    ylab("CO ppm") 
  # theme(axis.text.x = element_text(angle = 30, hjust = 1))
  # p = ggplotly(p,tooltip = c("emission_tags")) %>% layout(autosize = T, width = 1000, height = 300,margin=m)
  p
})

output$pats = renderPlot({
  p <- ggplot(aes(y = PM_Estimate, x = datetime), data = selected_pats()) +
    geom_point(aes(shape = emission_tags, colour = sampletype, group = qc), alpha=0.25) +
    theme_bw(10) +
    theme(legend.title=element_blank()) +
    xlab(" ") +
    coord_cartesian(xlim=c(selected_pre()$mindatetime,selected_pre()$maxdatetime)) +
    ylab("PATS+ ugm-3")
  # p = ggplotly(p,tooltip = c("emission_tags")) %>% layout(autosize = T, width = 1000, height = 300,margin=m)
  p
})

output$ecm = renderPlot({
  p <- ggplot(aes(y = PM_Estimate, x = datetime), data = selected_ecm()) +
    geom_point(aes(shape = emission_tags, colour = sampletype, group = qc), alpha=0.25) +
    theme_bw(10) +
    theme(legend.title=element_blank()) +
    xlab(" ") +
    coord_cartesian(xlim=c(selected_pre()$mindatetime,selected_pre()$maxdatetime)) +
    ylab("ECM/MicroPEM ugm-3")
  p
})

output$beacon=renderPlot({
  p <- ggplot(aes(y = nearest_RSSI, x = datetime), data = selected_beacon()) +
    geom_point(aes(shape = location_kitchen_threshold, colour = location_nearest), alpha=0.25) +
    theme_bw(10) +
    theme(legend.title=element_blank()) +
    xlab(" ") +
    coord_cartesian(xlim=c(selected_pre()$mindatetime,selected_pre()$maxdatetime)) +
    ylab("Beacon localization")
  p
})

output$tsi= renderPlot({
  p <- ggplot(data = selected_tsi(),aes(y = CO_ppm, x = datetime, shape = emission_tags, colour = emission_tags,group = qc), alpha=0.25) +
    geom_point()+
    geom_point(data = selected_tsi(),aes(y = CO2_ppm, x = datetime,shape = emission_tags, colour = emission_tags, group = qc), alpha=0.25) +
    theme(legend.title=element_blank()) +
    theme_bw(10) +
    scale_y_log10() +
    xlab(" ") +
    ylab("TSI CO2 and CO (ppm)")
  p
})

```

Deployment
===================================== 


```{r}
plotOutput("COppm")
```


```{r}
plotOutput("pats")


```


```{r}
plotOutput("beacon")

```

### {data-height=100}
```{r}

plotOutput("tsi")
```